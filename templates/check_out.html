{% extends 'blank_layout.html' %}
{% load static %}
{% block title %}Checkout{% endblock %}
{% block contant %}

<!-- Bootstrap CDN (for quick styling) -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
  :root{
    --brand:#124e66;
    --muted:#6b7280;
    --card:#ffffff;
    --bg:#f7fafc;
  }
  body{ background:var(--bg); font-family:Inter, system-ui, Arial, sans-serif; color:#1f2937; }
  .checkout-wrap{ max-width:1200px; margin:26px auto; padding:18px; }
  .panel{ background:var(--card); border-radius:12px; padding:18px; box-shadow:0 6px 18px rgba(15,23,42,0.06); }
  .address-card{ cursor:pointer; border:1px solid #e6eef3; padding:12px; border-radius:10px; background:#fff; transition:all .15s ease; }
  .address-card:hover{ transform:translateY(-3px); box-shadow:0 8px 18px rgba(16,24,40,0.06); }
  .address-card.selected{ border-color:var(--brand); box-shadow:0 8px 28px rgba(18,78,102,0.08); }
  .address-meta{ font-size:14px; color:var(--muted); }
  .coupon-btn{ border-radius:16px; border:1px solid var(--brand); padding:8px 12px; background:#fff; color:var(--brand); }
  .payment-option{ cursor:pointer; border-radius:10px; padding:8px; border:1px solid #e5eef3; display:inline-block; margin-right:8px; }
  .payment-option.selected{ border-color:var(--brand); background:linear-gradient(90deg, rgba(18,78,102,0.06), rgba(18,78,102,0.03)); }
  .place-btn{ background:var(--brand); color:white; border:none; padding:12px 18px; border-radius:10px; font-weight:600; }
  @media (max-width:991px){
    .flex-desktop{ flex-direction:column; gap:18px; }
  }
</style>

<div class="checkout-wrap">
  <div class="row gx-4">
    <div class="col-12 mb-3">
      <h2 class="mb-0">Checkout</h2>
      <small class="text-muted">Review your items and place order</small>
    </div>

    <!-- LEFT: Addresses + Form -->
    <div class="col-lg-7">
      <div class="panel mb-3">
        <h5 class="mb-3">Select delivery address</h5>

        <!-- Address cards -->
        <div class="row g-3 mb-3" id="addressList">
          {% if addresses %}
            {% for address in addresses %}
            <div class="col-md-6">
              <div class="address-card" tabindex="0" data-id="{{ address.id }}"
                   data-state="{{ address.state|default:'' }}"
                   data-district="{{ address.district|default:'' }}"
                   data-city="{{ address.city|default:'' }}"
                   data-place="{{ address.place|default:'' }}"
                   data-pin="{{ address.pin|default:'' }}"
                   data-road="{{ address.road|default:'' }}"
                   data-house_name="{{ address.house_name|default:'' }}"
                   data-landmark="{{ address.landmark|default:'' }}"
                   data-name="{{ address.name|default:'' }}"
                   data-phone="{{ address.phone|default:'' }}">
                <div class="d-flex justify-content-between bg-info">
                  <ul>
                    <strong>{{ address.name }}</strong>
                    <li class="address-meta fw-bold">HOUSE:{{ address.house_name }}</li>
                    <li class="address-meta fw-bold">PLACE:{{ address.place }},</li>
                     <li class="address-meta fw-bold">City:{{ address.city }}</li>
                    <li class="address-meta fw-bold">PIN: {{ address.pin }} • {{ address.phone }}</li>
                  </ul>
                  <div class="text-end m-2">
                    <small class="text-muted ">Saved</small>
                    <div style="font-size:12px; margin-top:6px;">
                      <button class="btn btn-sm btn-outline-secondary select-address-btn">Use</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
          {% else %}
            <div class="col-12">
              <div class="alert alert-info small mb-0">No saved addresses. Use the form below to add one.</div>
            </div>
          {% endif %}
        </div>

        <hr>

        <!-- Address form (does NOT replace name & phone when selecting card) -->
        <form id="checkoutForm">
          {% csrf_token %}
          <div class="row g-2">
            <div class="col-md-6">
              <label class="form-label small">State</label>
              <input id="state" name="state" class="form-control form-control-sm" placeholder="State" required>
            </div>
            <div class="col-md-6">
              <label class="form-label small">District</label>
              <input id="district" name="district" class="form-control form-control-sm" placeholder="District" required>
            </div>

            <div class="col-md-6">
              <label class="form-label small">City</label>
              <input id="city" name="city" class="form-control form-control-sm" placeholder="City" required>
            </div>
            <div class="col-md-6">
              <label class="form-label small">Place / Area</label>
              <input id="place" name="place" class="form-control form-control-sm" placeholder="Place / locality" required>
            </div>

            <div class="col-md-6">
              <label class="form-label small">PIN code</label>
              <input id="pin" name="pin" class="form-control form-control-sm" placeholder="PIN" required inputmode="numeric">
            </div>
            <div class="col-md-6">
              <label class="form-label small">Road / Street</label>
              <input id="road" name="road" class="form-control form-control-sm" placeholder="Road / street" required>
            </div>

            <div class="col-md-6">
              <label class="form-label small">House / Flat</label>
              <input id="house_name" name="house_name" class="form-control form-control-sm" placeholder="House / Flat" required>
            </div>
            <div class="col-md-6">
              <label class="form-label small">Landmark</label>
              <input id="landmark" name="landmark" class="form-control form-control-sm" placeholder="Landmark" required>
            </div>

            <!-- NOTE: we DO NOT overwrite name/phone when selecting a saved address.
                 user can edit name/phone manually if needed. -->
            <div class="col-md-6">
              <label class="form-label small">Full name</label>
              <input id="name" name="name" class="form-control form-control-sm" placeholder="Full name" value="{{ user.first_name }} {{ user.last_name }}" required>
            </div>
            <div class="col-md-6">
              <label class="form-label small">Phone</label>
              <input id="phone" name="phone" class="form-control form-control-sm" placeholder="Phone" value="{{ user.phone }}" required inputmode="tel">
            </div>

            <div class="col-12">
              <div class="form-check">
                <input id="save_address" name="save_address" class="form-check-input" type="checkbox" value="yes">
                <label class="form-check-label small" for="save_address">Save this address for next time</label>
              </div>
            </div>

            <!-- hidden fields -->
            <input type="hidden" id="discount" name="discount" value="{{ discount }}">
            <input type="hidden" id="pymd" name="pymd" value="">
            <input type="hidden" id="coupon_code" name="coupon_code" value="{{ request.session.coupon_code|default:'' }}">
          </div>
        </form>

      </div>
    </div>

    <!-- RIGHT: Order summary, coupon, payment -->
    <div class="col-lg-5">
      <div class="panel mb-3">
        <h5>Order summary</h5>

        <div class="mt-3">
          <ul class="list-unstyled">
            {% for cart in carts %}
            <li class="d-flex justify-content-between align-items-center mb-2">
              <div class="d-flex align-items-center">
                <img src="{{ cart.variant.image.url }}" alt="" style="width:56px;height:56px;border-radius:8px;object-fit:cover;margin-right:10px;">
                <div>
                  <div style="font-weight:600;">{{ cart.variant.product.name }}</div>
                  <small class="text-muted">Qty: {{ cart.quantity }}</small>
                </div>
              </div>
              <div style="font-weight:600;">₹{{ cart.price }}</div>
            </li>
            {% endfor %}
          </ul>
        </div>

        <hr>

        <div class="d-flex justify-content-between small">
          <div>Subtotal</div>
          <div>₹ <span id="subtotal">{{ subtotal }}</span></div>
        </div>
        <div class="d-flex justify-content-between small">
          <div>Tax</div>
          <div>₹ <span id="tax">{{ tax }}</span></div>
        </div>
        <div class="d-flex justify-content-between small">
          <div>Delivery</div>
          <div>₹ <span id="delivery">{{ delivery_charge }}</span></div>
        </div>
        <div class="d-flex justify-content-between small mt-2">
          <div>Discount</div>
          <div>₹ <span id="discountpersent">{{ discount }}</span></div>
        </div>

        <div class="d-flex justify-content-between mt-3" style="font-size:18px;font-weight:700;">
          <div>Total</div>
          <div>₹ <span id="total">{{ total }}</span></div>
        </div>

        <hr>

        <!-- coupon input + quick buttons -->
        <div class="mb-2">
          <div class="d-flex gap-2">
            <input id="coupon_input" class="form-control form-control-sm" placeholder="Coupon code (or click below)" readonly>
            <button id="apply-btn" class="btn btn-sm" style="background:var(--brand); color:#fff;">Apply</button>
            <button id="removeCouponBtn" class="btn btn-sm btn-outline-secondary" style="display:none;">Remove</button>
          </div>
          <input type="hidden" id="total_price" value="{{ total_before_discount }}">
        </div>

        <div class="mb-2">
          <div class="d-flex flex-wrap gap-2">
            {% for coupon in coupons %}
              <button class="coupon-btn" data-code="{{ coupon.code }}" data-perc="{{ coupon.percentage }}">{{ coupon.code }} • {{ coupon.percentage }}%</button>
            {% endfor %}
          </div>
        </div>

        <hr>

        <h6>Select Payment</h6>
<div class="mb-3">
  <div id="paymentOptions" class="d-flex align-items-center gap-2">
    <!-- Cash on Delivery -->
    <div class="payment-option" data-method="cash on delivery" id="opt-cod">
      <img src="{% static 'images/cod.jpg' %}" alt="COD" style="width:50px; height:auto;">
      
    </div>

    <!-- Wallet Payment -->
    {% if wallet and wallet.balence >= total %}
      <div class="payment-option" data-method="wallet payment" id="opt-wallet">
        <img src="{% static 'images/wallet.png' %}" alt="Wallet" style="width:50px; height:auto;">
         (₹{{ wallet.balence }})
      </div>
    {% endif %}

    <!-- Razorpay -->
    <div class="payment-option" data-method="Razorpay" id="opt-razor">
      <img src="{% static 'images/razorpay.png' %}" alt="Razorpay" style="width:50px; height:auto;">
      
    </div>
  </div>
</div>

       
        <div class="d-grid">
          <button id="place-order" class="place-btn place-btn-lg">Place Order</button>
        </div>

        <small class="text-muted d-block mt-2">You will be redirected after payment. Make sure address fields are filled.</small>
      </div>
    </div>
  </div>
</div>

<!-- JS libs -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<!-- Optional Toastify if you use it; if not, checks will skip -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

<script>
  // UX helpers
  function toast(msg, bg){
    if(window.Toastify){
      Toastify({ text: msg, duration: 3000, backgroundColor: bg || "#124e66" }).showToast();
    } else {
      alert(msg);
    }
  }

  // Address selection: populate only address fields (NOT name / phone)
  $(document).ready(function(){
    $('#addressList .address-card').on('click', function(){
      $('#addressList .address-card').removeClass('selected');
      $(this).addClass('selected');

      // populate only address fields — we do NOT overwrite #name or #phone
      $('#state').val($(this).data('state') || '');
      $('#district').val($(this).data('district') || '');
      $('#city').val($(this).data('city') || '');
      $('#place').val($(this).data('place') || '');
      $('#pin').val($(this).data('pin') || '');
      $('#road').val($(this).data('road') || '');
      $('#house_name').val($(this).data('house_name') || '');
      $('#landmark').val($(this).data('landmark') || '');

      // set hidden coupon/address id if you want (we keep form input IDs same)
      $('#checkoutForm').data('selected-address-id', $(this).data('id'));
      toast('Address selected', '#2d6a78');
    });

    // quick "Use" button inside card
    $('.select-address-btn').on('click', function(e){
      e.preventDefault();
      $(this).closest('.address-card').trigger('click');
    });
  });

  // Coupon selection helper (fills coupon input)
  $('.coupon-btn').on('click', function(){
    const code = $(this).data('code');
    $('#coupon_input').val(code);
  });

  // Apply coupon AJAX
  $('#apply-btn').on('click', function(e){
    e.preventDefault();
    const code = $('#coupon_input').val();
    if(!code){
      toast('Choose or type a coupon', '#ff6347');
      return;
    }
    $.ajax({
      url: "{% url 'apply_coupon' %}",
      type: "POST",
      data: {
        coupon: code,
        total_price: $('#total_price').val(),
        csrfmiddlewaretoken: '{{ csrf_token }}'
      },
      success: function(resp){
        if(resp.success){
          $('#discount').val(resp.discount);
          $('#discountpersent').text(resp.discount);
          $('#total').text(resp.total);
          $('#coupon_code').val(resp.coupon_code);
          $('#removeCouponBtn').show();
          toast('Coupon applied: ₹' + resp.discount, '#16a34a');

          // It's safer to reload to recreate razorpay order id on server for new amount.
          // If you prefer no reload, implement an endpoint to re-create razorpay order and update `razorpay_order_id` in JS.
          setTimeout(()=> location.reload(), 700);
        } else {
          toast(resp.message || 'Coupon invalid', '#ff6347');
        }
      },
      error: function(){ toast('Server error', '#ff6347'); }
    });
  });

  // Remove coupon
  $('#removeCouponBtn').on('click', function(e){
    e.preventDefault();
    $.ajax({
      url: "{% url 'remove_coupon' %}",
      type: "POST",
      data: { csrfmiddlewaretoken: '{{ csrf_token }}' },
      success: function(resp){
        if(resp.status === 'removed'){
          $('#discount').val(0);
          $('#discountpersent').text('0.00');
          $('#coupon_input').val('');
          $('#coupon_code').val('');
          toast('Coupon removed', '#f97316');
          setTimeout(()=> location.reload(), 400);
        }
      },
      error: function(){ toast('Server error', '#ff6347'); }
    });
  });

  // Payment selection UI
  let selectedPayment = '';
  $('#paymentOptions .payment-option').on('click', function(){
    $('#paymentOptions .payment-option').removeClass('selected');
    $(this).addClass('selected');
    selectedPayment = $(this).data('method');
    $('#pymd').val(selectedPayment);
  });

  // Place order logic
  $('#place-order').on('click', function(e){
    e.preventDefault();

    // Validate address fields (ensure user entered or selected one)
    const required = ['#state','#district','#city','#place','#pin','#road','#house_name','#landmark','#name','#phone'];
    for(let sel of required){
      if($(sel).val().trim() === ''){
        toast(sel.replace('#','') + ' is required', '#ff6347');
        $(sel).focus();
        return;
      }
    }

    if(!selectedPayment){
      toast('Select a payment method', '#ff6347');
      return;
    }

    // For Razorpay: open popup using server-provided amount and order_id (do NOT do discount math here)
    if(selectedPayment === 'Razorpay'){
      const options = {
        "key": "{{ RAZORPAY_API_KEY }}",  // pass from view context (public key)
        "amount": {{ amount }},          // amount (paise) from server
        "currency": "INR",
        "name": "Lapcon",
        "description": "Order Payment",
        "order_id": "{{ razorpay_order_id }}",
        "handler": function(response){
          // On success, submit AJAX order with payment info and status done
          submitOrderAjax(response, 'done');
        }
      };
      const rzp = new Razorpay(options);
      rzp.open();

      rzp.on('payment.failed', function(response){
        // If failed, you may still want to record attempt as pending
        submitOrderAjax(response, 'failed');
      });

    } else {
      // COD or Wallet — call server endpoint to create order directly (status handled server-side)
      const pyst = selectedPayment === 'wallet payment' ? 'done' : 'pending';
      submitOrderAjax(null, pyst);
    }
  });

  function submitOrderAjax(razorResponse, pystStatus){
    const data = {
      csrfmiddlewaretoken: '{{ csrf_token }}',
      state: $('#state').val(),
      district: $('#district').val(),
      city: $('#city').val(),
      place: $('#place').val(),
      pin: $('#pin').val(),
      road: $('#road').val(),
      house_name: $('#house_name').val(),
      landmark: $('#landmark').val(),
      name: $('#name').val(),
      phone: $('#phone').val(),
      pymd: $('#pymd').val(),
      discount: $('#discount').val(),
      pyst: pystStatus,
      coupon_code: $('#coupon_code').val(),
      save_address: $('#save_address').is(':checked') ? 'yes' : 'no'
    };

    if(razorResponse){
      data.razorpay_payment_id = razorResponse.razorpay_payment_id || '';
      data.razorpay_order_id = razorResponse.razorpay_order_id || '';
      data.razorpay_signature = razorResponse.razorpay_signature || '';
    }

    $.ajax({
      url: "{% url 'order' %}",
      type: "POST",
      data: data,
      success: function(resp){
        if(resp.status === 'success'){
          toast('Order placed!', '#10b981');
          window.location.href = "{% url 'susses' %}";
        } else if(resp.status === 'failed'){
          toast(resp.message || 'Order failed', '#ff6347');
          if(resp.message && resp.message.toLowerCase().includes('stock')){
            setTimeout(()=> window.location.href = "{% url 'view_cart' %}", 900);
          }
        } else if(resp.status === 'unauthenticated'){
          toast('Please login', '#ff6347');
          setTimeout(()=> window.location.href = "{% url 'signin' %}", 700);
        } else {
          toast('Unexpected response', '#ff6347');
        }
      },
      error: function(xhr){
        toast('Server error', '#ff6347');
      }
    });
  }
</script>

{% endblock %}
