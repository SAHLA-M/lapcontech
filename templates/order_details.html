{% extends 'blank_layout.html' %}
{% load static %}
{% block title %}Order details {% endblock %}
{% block contant %}
<style>
    .invoice-card {
        border: 1px solid #ccc;
        border-radius: 50px;
        padding: 20px;
        margin-bottom: 10px;
    }
    .invoice-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .invoice-header h2 {
        margin: 0;
    }
    .invoice-header .btn {
        margin-left: 10px;
    }
    .invoice-details {
        margin-top: 20px;
    }
    .btn-danger {
        color: #ffffff;
        background-color: red;
        border: red 1px solid;
    }
    .invoice-header { text-align: center; }
    .invoice-details { margin-top: 20px; }
    .invoice-details th, .invoice-details td { padding: 8px; border: 1px solid #ddd; }
    .total { text-align: right; margin-top: 20px; }
</style>
<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');
</script>


<!-- All Products -->
<br><br><br>
<div class="container mt-5">
    <div class="invoice-card" style="display: flex; flex-wrap: wrap;">
        <img src="{{order_item.variant.image.url}}" style="width: 28%;">
        <div>
        <div class="invoice-header">
            <h3 class="fw-bold">{{order_item.variant.product.name}}</h3>
            <div>
                {% if order_item.status != 'delivered' and order_item.status != 'cancelled' %}
                    <button type="button" class="btn btn-danger" id="cancel_order">cancel order</button>
                    {% endif %}

                    {% if order_item.status == 'delivered' %}
                     <form id="returnForm{{ order_item.id }}" method="POST" action="{% url 'return_order' order_item.id %}">
                                {% csrf_token %}
                                <input type="hidden" name="reason" id="reasonInput{{ order_item.id }}">
                            </form>

                            <button class="btn btn-danger return-btn" data-id="{{ order_item.id }}">
                                Return
                            </button>
                       
                    <a class="btn btn-secondary" href="{% url 'generate_invoice_pdf' order_item.id %}">Invoice</a>
                    {% endif %}
                {% if order_item.order.pyment_status == 'pending' and order_item.order.pyment_method == 'Razorpay'%}
                    <a class="btn btn-secondary" id="retry_Payment">Retry Payment</a>
                {% endif %}
               
            </div>
            
        </div>
        <div class="invoice-details">
            <p><strong>Unit Price:</strong> ₹ {{order_item.unit_price}}</p>
            <p><strong>Quantity:</strong>  {{order_item.quantity}}</p>
            <p><strong>Total price:</strong> ₹ {{order_item.price}}</p>
            <p><strong>Disscount:</strong>- ₹ {{order_item.order.discount}}</p>
            <p><strong>Buyer:</strong> {{order_item.order.delivery_address.name}}</p>
            <p><strong>Address:</strong> {{order_item.order.delivery_address.house_name}}, {{order_item.order.delivery_address.road}}, 
                {{order_item.order.delivery_address.place}}, {{order_item.order.delivery_address.district}}, {{order_item.order.delivery_address.state}}, India</p>
            <p><strong>Order placed on:</strong> {{order_item.order.order_date}}</p>
            <p><strong>Order status:</strong> {{order_item.status}}</p>
            <p><strong>Payment option:</strong> {{order_item.order.pyment_method}}</p>
            <p><strong>Payment status:</strong> {{order_item.order.pyment_status}}</p>
            {% if order_item.status != 'delivered'%}
            <p><strong>Order will be deliverd befor :</strong> {{order_item.order.delivery_date}}</p>
            {%endif%}
        </div></div>
    </div>
</div>
<div class="text-center mt-4">
    <a href="{% url 'home' %}" class="btn btn-primary" style="padding:10px 20px; border-radius:8px;">
        Continue Shopping
    </a>
</div>


<br><br><br><br><br>

<!-- javascript -->
 <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
  // Optional menu guard (prevents JS from dying if #MenuItems is missing)
  const MenuItems = document.getElementById("MenuItems");
  if (MenuItems) {
    MenuItems.style.maxHeight = "0px";
    window.menutoggle = function () {
      MenuItems.style.maxHeight = (MenuItems.style.maxHeight === "0px") ? "200px" : "0px";
    };
  }

  // CANCEL ORDER
  const cancelBtn = document.getElementById('cancel_order');
  if (cancelBtn) {
    cancelBtn.addEventListener('click', function (e) {
      e.preventDefault();

      Swal.fire({
        title: 'Are you sure?',
        text: 'Do you really want to cancel this order?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Yes, cancel!',
        cancelButtonText: 'No, go back',
      }).then((result) => {
        if (result.isConfirmed) {
          // Redirect to Django view
          window.location.href = "{% url 'cancel_order' order_item.id %}";
        }
      });
    });
  }

  // RETURN ORDER
 
});
</script>
<script>
  document.querySelectorAll(".return-btn").forEach(btn => {
    btn.addEventListener("click", function () {
        let id = this.dataset.id;

        Swal.fire({
            title: 'Return Reason',
            input: 'textarea',
            inputLabel: 'Why are you returning this item?',
            inputPlaceholder: 'Write the reason...',
            showCancelButton: true,
            confirmButtonText: 'Submit',
            cancelButtonText: 'Cancel',
            preConfirm: (reason) => {
                if (!reason) {
                    Swal.showValidationMessage("Reason is required");
                }
                return reason;
            }
        }).then((result) => {
            if (result.isConfirmed) {
                // Put the reason into hidden input
                document.getElementById("reasonInput" + id).value = result.value;

                // Submit the form normally (your redirect works)
                document.getElementById("returnForm" + id).submit();
            }
        });
    });
});

</script>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
    document.getElementById('retry_Payment').onclick = function(e) {
        e.preventDefault();

        $.post("{% url 'retry_Payment' %}", {
        csrfmiddlewaretoken: '{{ csrf_token }}',
        pyst: 'pending',
        order_id: "{{ order_item.order.id }}"
    }, function(data) {
        
        var options = {
            "key": data.razorpay_key,
            "order_id": data.razorpay_order_id,
            "currency": "INR",
            "name": "Lapcon",
            "description": "Purchase Description",
            "image": "{% static 'images/logolapcon.png' %}",
            
            "handler": function (response) {
                 $.post("{% url 'retry_Payment' %}", {
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                    pyst: 'done',
                    order_id: "{{ order_item.order.id }}"
                }, function(res){
                    window.location.href = "{% url 'susses' %}";
                });

            }
        };

        var rzp = new Razorpay(options);
        rzp.open();
    });
};

                
</script>
          


{% endblock %}